name: Build, Scan, and Push to GHCR

on:
  push:
    branches:
      - main # mainブランチへのプッシュをトリガーとする

env:
  # ベースとなる環境変数はそのまま残す
  REGISTRY: ghcr.io
  # IMAGE_TAG は後続ステップで上書きされるため、一旦削除または残していても問題なし
  
jobs:
  build_scan_push:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write # GHCRにプッシュするために必要
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # ----------------------------------------------------------------------
    # 💡 修正ステップ: bashのtrコマンドで小文字に変換し、環境変数に設定
    # ----------------------------------------------------------------------
    - name: Set valid Docker repository and tag names
      id: set_names
      run: |
        # リポジトリ名を小文字に変換
        REPO_NAME_LOWER=$(echo ${{ github.event.repository.name }} | tr '[:upper:]' '[:lower:]')
        echo "REPO_NAME_LOWER=$REPO_NAME_LOWER" >> $GITHUB_ENV
        
        # オーナー名を小文字に変換
        OWNER_NAME_LOWER=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')
        echo "OWNER_NAME_LOWER=$OWNER_NAME_LOWER" >> $GITHUB_ENV
        
        # 最終的なイメージ名とSHAタグを環境変数に設定
        FULL_IMAGE_NAME="${{ env.REGISTRY }}/$OWNER_NAME_LOWER/$REPO_NAME_LOWER"
        SHA_TAG="$FULL_IMAGE_NAME:${{ github.sha }}"
        
        echo "FULL_IMAGE_NAME=$FULL_IMAGE_NAME" >> $GITHUB_ENV
        echo "SHA_TAG=$SHA_TAG" >> $GITHUB_ENV

    # ----------------------------------------------------------------------
    # 1. GHCRログイン
    # ----------------------------------------------------------------------
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    # ----------------------------------------------------------------------
    # 2. ビルド & スキャン (Trivy)
    # ----------------------------------------------------------------------
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build image and Load for Trivy Scan
      uses: docker/build-push-action@v5
      with:
        context: .
        # 小文字化した変数を使用
        tags: ${{ env.SHA_TAG }}
        load: true # スキャンのためにローカルにロード

    - name: Run Trivy vulnerability scanner on the built image
      uses: aquasecurity/trivy-action@master
      with:
        # 小文字化した変数を使用
        image-ref: ${{ env.SHA_TAG }}
        format: 'table'
        exit-code: '1'
        severity: 'CRITICAL,HIGH'
        
    # ----------------------------------------------------------------------
    # 3. プッシュ (GHCR)
    # ----------------------------------------------------------------------
    - name: Push image to GitHub Container Registry (GHCR)
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        # 💡 latest と SHA タグの両方をプッシュ
        tags: |
          ${{ env.SHA_TAG }}
          ${{ env.FULL_IMAGE_NAME }}:latest