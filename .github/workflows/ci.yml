name: Build, Scan, and Push to GHCR

on:
  push:
    branches:
      - main # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã‚’ãƒˆãƒªã‚¬ãƒ¼ã¨ã™ã‚‹

env:
  # ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹ç’°å¢ƒå¤‰æ•°ã¯ãã®ã¾ã¾æ®‹ã™
  REGISTRY: ghcr.io
  # IMAGE_TAG ã¯å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§ä¸Šæ›¸ãã•ã‚Œã‚‹ãŸã‚ã€ä¸€æ—¦å‰Šé™¤ã¾ãŸã¯æ®‹ã—ã¦ã„ã¦ã‚‚å•é¡Œãªã—
  
jobs:
  build_scan_push:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write # GHCRã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ãŸã‚ã«å¿…è¦
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # ----------------------------------------------------------------------
    # ğŸ’¡ ä¿®æ­£ã‚¹ãƒ†ãƒƒãƒ—: bashã®trã‚³ãƒãƒ³ãƒ‰ã§å°æ–‡å­—ã«å¤‰æ›ã—ã€ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
    # ----------------------------------------------------------------------
    - name: Set valid Docker repository and tag names
      id: set_names
      run: |
        # ãƒªãƒã‚¸ãƒˆãƒªåã‚’å°æ–‡å­—ã«å¤‰æ›
        REPO_NAME_LOWER=$(echo ${{ github.event.repository.name }} | tr '[:upper:]' '[:lower:]')
        echo "REPO_NAME_LOWER=$REPO_NAME_LOWER" >> $GITHUB_ENV
        
        # ã‚ªãƒ¼ãƒŠãƒ¼åã‚’å°æ–‡å­—ã«å¤‰æ›
        OWNER_NAME_LOWER=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')
        echo "OWNER_NAME_LOWER=$OWNER_NAME_LOWER" >> $GITHUB_ENV
        
        # æœ€çµ‚çš„ãªã‚¤ãƒ¡ãƒ¼ã‚¸åã¨SHAã‚¿ã‚°ã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
        FULL_IMAGE_NAME="${{ env.REGISTRY }}/$OWNER_NAME_LOWER/$REPO_NAME_LOWER"
        SHA_TAG="$FULL_IMAGE_NAME:${{ github.sha }}"
        
        echo "FULL_IMAGE_NAME=$FULL_IMAGE_NAME" >> $GITHUB_ENV
        echo "SHA_TAG=$SHA_TAG" >> $GITHUB_ENV

    # ----------------------------------------------------------------------
    # 1. GHCRãƒ­ã‚°ã‚¤ãƒ³
    # ----------------------------------------------------------------------
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    # ----------------------------------------------------------------------
    # 2. ãƒ“ãƒ«ãƒ‰ & ã‚¹ã‚­ãƒ£ãƒ³ (Trivy)
    # ----------------------------------------------------------------------
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build image and Load for Trivy Scan
      uses: docker/build-push-action@v5
      with:
        context: .
        # å°æ–‡å­—åŒ–ã—ãŸå¤‰æ•°ã‚’ä½¿ç”¨
        tags: ${{ env.SHA_TAG }}
        load: true # ã‚¹ã‚­ãƒ£ãƒ³ã®ãŸã‚ã«ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒ­ãƒ¼ãƒ‰

    - name: Run Trivy vulnerability scanner on the built image
      uses: aquasecurity/trivy-action@master
      with:
        # å°æ–‡å­—åŒ–ã—ãŸå¤‰æ•°ã‚’ä½¿ç”¨
        image-ref: ${{ env.SHA_TAG }}
        format: 'table'
        exit-code: '1'
        severity: 'CRITICAL,HIGH'
        
    # ----------------------------------------------------------------------
    # 3. ãƒ—ãƒƒã‚·ãƒ¥ (GHCR)
    # ----------------------------------------------------------------------
    - name: Push image to GitHub Container Registry (GHCR)
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        # ğŸ’¡ latest ã¨ SHA ã‚¿ã‚°ã®ä¸¡æ–¹ã‚’ãƒ—ãƒƒã‚·ãƒ¥
        tags: |
          ${{ env.SHA_TAG }}
          ${{ env.FULL_IMAGE_NAME }}:latest